
Step 1:

git clone https://github.com/sdss/lvm.git
cd lvm
mkdir wasndas
(cd wasndas && git clone https://github.com/wasndas/lvmjupyter)
(cd wasndas && git clone https://github.com/wasndas/lvmcam)
(cd wasndas && git clone https://github.com/wasndas/lvmagp)

mkdir -p var/data && chmod 777 var/data
mkdir -p var/jupyter && chmod 777 var/jupyter
mkdir -p var/rabbitmq && chmod 777 var/rabbitmq

Step 2: Installing Minikube

# https://minikube.sigs.k8s.io/docs/start/

1. Install minikube

wget https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
chmod +x minikube-linux-amd64
minikube-linux-amd64 ~/.local/bin/minikube # or: sudo mv minikube-linux-amd64 /usr/local/bin/minikube
minikube version

Step 3: Installing Kubectl

1. Install kubectl
curl -LO https://storage.googleapis.com/kubernetes-release/release/`curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt`/bin/linux/amd64/kubectl
chmod +x kubectl
mv kubectl ~/.local/bin/ # or: sudo mv kubectl  /usr/local/bin/
kubectl version --client -o json

2a. Add passwordless sudo for podman

USER_SUDO_FILE=/etc/sudoers.d/$USER;  echo "$USER ALL=(ALL) NOPASSWD: /usr/bin/podman" | sudo tee -a $USER_SUDO_FILE > /dev/null

2a. Add  docker group
sudo usermod -aG docker $USER && newgrp docker

export LVM_ROOT=$PWD

minikube config set driver podman
minikube config set container-runtime cri-o

minikube start --mount --mount-string="$LVM_ROOT:/lvm" --extra-config=kubelet.housekeeping-interval=10s  --memory 32768 --cpus=8 
 
# minikube start --mount --mount-string="$LVM_ROOT:/lvm" --extra-config=kubelet.housekeeping-interval=10s --network-plugin=cni --cni=flannel
#--memory 4096 --cpus 2 --network=host

minikube status 

#https://robotics.stackexchange.com/questions/15745/how-can-i-receive-genicam-packets-from-a-device-in-a-docker-container

minikube addons list
minikube addons enable metrics-server
minikube addons enable dashboard
minikube addons list

minikube ip

minikube dashboard --url&

kubectl proxy&
kubectl proxy --address='0.0.0.0'&

# http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/http:kubernetes-dashboard:/proxy/#/pod?namespace=default

kubectl create -f config/kube/rabbitmq.yaml

kubectl create -f $LVM_ROOT/config/kube/lvm_moe-sim.yaml 

minikube build --tag localhost/lvm_actor:$(date +"%y%m%d") ${LVM_ROOT}/config/container/actor/

kubectl create -f $LVM_ROOT/config/kube/lvm_scraper.yaml

kubectl create -f $LVM_ROOT/config/kube/lvm_sci_pwi-sim.yaml
kubectl create -f $LVM_ROOT/config/kube/lvm_skyw_pwi-sim.yaml
kubectl create -f $LVM_ROOT/config/kube/lvm_skye_pwi-sim.yaml
kubectl create -f $LVM_ROOT/config/kube/lvm_spec_pwi-sim.yaml

vncviewer $(minikube ip):1
vncviewer $(minikube ip):2
vncviewer $(minikube ip):3
vncviewer $(minikube ip):4

kubectl create -f $LVM_ROOT/config/kube/lvm_sci_agcam-sim.yaml
kubectl create -f $LVM_ROOT/config/kube/lvm_skyw_agcam-sim.yaml
kubectl create -f $LVM_ROOT/config/kube/lvm_skye_agcam-sim.yaml
kubectl create -f $LVM_ROOT/config/kube/lvm_spec_agcam-sim.yaml

kubectl create -f $LVM_ROOT/config/kube/jupyter.yaml

niceQUI --MOE.CONFIG:Endpoint=[NAME=lvm.moe-sim,HOST=$(minikube ip),PORT=40000]+UI=$LVM_ROOT/lvmtan/config/lvm/lvm.all.ui 
python3.9 $LVM_ROOT/wasndas/lvmcam/utils/simple_camui.py -c lvm.sci.agcam -k lvm.sci.km -t lvm.sci.pwi -H $(minikube ip)


kubectl delete -n default pod lvm_moe-sim&

kubectl delete -n default pod lvm-sci-pwi-sim&
kubectl delete -n default pod lvm-skyw-pwi-sim&
kubectl delete -n default pod lvm-skye-pwi-sim&
kubectl delete -n default pod lvm-spec-pwi-sim&


apt update
apt install -y iputils-ping iproute2



ip route add 10.96.0.0/12 via $(minikube ip) # svc
ip route add 172.17.0.0/16 via $(minikube ip) # pods

kubectl create -f config/kube/kube-flannel.yml
kubectl apply -f /usr/share/k8s-yaml/multus/multus.yaml

# https://jamesdefabia.github.io/docs/user-guide/kubectl-cheatsheet/
# https://minikube.sigs.k8s.io/docs/handbook/pushing/

# access minikube container
minikube ssh -- sudo podman images
# or
sudo podman exec -ti minikube podman images

# access minkube images
minikube image ls
minikube image build --tag localhost/lvm_actor:$(date +"%y%m%d") $()/config/container/actor/



# external 
# minikube addons enable registry
# minikube image push 192.168.49.2:5000/lvm_actor



kubectl get pod,svc -n default
kubectl create -f config/kube/lvm_sci_pwi-sim.yaml
kubectl exec lvm-sci-pwi-sim -- capsh --print

# TODO

https://kubernetes.io/docs/concepts/configuration/configmap/


# https://github.com/flannel-io/flannel/blob/master/Documentation/kube-flannel.yml
kubectl get psp
kubectl create -f config/kube/lvm_sci_pwi-sim.yaml

https://github.com/kvaps/bridget/

kubectl apply -f https://raw.githubusercontent.com/k8snetworkplumbingwg/multus-cni/master/deployments/multus-daemonset-thick-plugin.yml
